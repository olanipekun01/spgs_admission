<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
</head>
<body class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-[#722F37]">SPA</h1>
                    </div>
                    <div class="ml-4">
                        <h2 class="text-lg font-medium text-gray-700">Payment Portal</h2>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="p-1 text-gray-600 hover:text-gray-900">
                        <i data-lucide="bell" class="h-4 w-4"></i>
                    </button>
                    <button class="p-1 text-gray-600 hover:text-gray-900">
                        <i data-lucide="settings" class="h-4 w-4"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <img src="/placeholder.svg?height=40&width=40" alt="Profile" class="h-8 w-8 rounded-full">
                        <span class="text-sm font-medium text-gray-700">John Doe</span>
                    </div>
                    <button class="p-1 text-gray-600 hover:text-gray-900">
                        <i data-lucide="log-out" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <button onclick="window.history.back()" class="mb-4 text-[#722F37] hover:text-[#5a252a] flex items-center">
                <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>
                Back to Dashboard
            </button>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Application Fee Payment</h1>
            <p class="text-gray-600">Complete your payment to proceed with your postgraduate application.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Payment Form -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow-lg border-0 rounded-lg">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold flex items-center">
                            <i data-lucide="credit-card" class="h-5 w-5 mr-2 text-[#722F37]"></i>
                            Payment Information
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <!-- Payment Status Messages -->
                        <div id="payment-status" class="hidden"></div>

                        <!-- Personal Information -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Personal Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label for="firstName" class="text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <i data-lucide="user" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"></i>
                                        <input id="firstName" value="{{user.first_name}}" class="pl-10 w-full border-gray-300 rounded-md" placeholder="Enter first name">
                                    </div>
                                    <p id="firstName-error" class="text-sm text-red-600 hidden"></p>
                                </div>
                                <div class="space-y-2">
                                    <label for="lastName" class="text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <i data-lucide="user" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"></i>
                                        <input id="lastName" value="{{user.last_name}}" class="pl-10 w-full border-gray-300 rounded-md" placeholder="Enter last name">
                                    </div>
                                    <p id="lastName-error" class="text-sm text-red-600 hidden"></p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label for="email" class="text-sm font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i data-lucide="mail" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"></i>
                                    <input id="email" type="email" value="{{user.email}}" class="pl-10 w-full border-gray-300 rounded-md" placeholder="Enter email address">
                                </div>
                                <p id="email-error" class="text-sm text-red-600 hidden"></p>
                            </div>
                            <!-- <div class="space-y-2">
                                <label for="phone" class="text-sm font-medium text-gray-700">Phone Number <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <i data-lucide="phone" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"></i>
                                    <input id="phone" class="pl-10 w-full border-gray-300 rounded-md" placeholder="Enter phone number">
                                </div>
                                <p id="phone-error" class="text-sm text-red-600 hidden"></p>
                            </div> -->
                        </div>

                        <!-- Payment Method -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Payment Method</h3>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-3 p-4 border rounded-lg hover:bg-gray-50">
                                    <input type="radio" id="card" name="paymentMethod" value="card" checked class="h-4 w-4">
                                    <label for="card" class="flex items-center cursor-pointer flex-1">
                                        <i data-lucide="credit-card" class="h-5 w-5 mr-3 text-[#722F37]"></i>
                                        <div>
                                            <div class="font-medium">Debit/Credit Card</div>
                                            <div class="text-sm text-gray-500">Pay with your Visa, Mastercard, or Verve card</div>
                                        </div>
                                    </label>
                                </div>
                                <div class="flex items-center space-x-3 p-4 border rounded-lg hover:bg-gray-50">
                                    <input type="radio" id="bank" name="paymentMethod" value="bank" class="h-4 w-4">
                                    <label for="bank" class="flex items-center cursor-pointer flex-1">
                                        <i data-lucide="banknote" class="h-5 w-5 mr-3 text-[#722F37]"></i>
                                        <div>
                                            <div class="font-medium">Bank Transfer</div>
                                            <div class="text-sm text-gray-500">Pay directly from your bank account</div>
                                        </div>
                                    </label>
                                </div>
                                <div class="flex items-center space-x-3 p-4 border rounded-lg hover:bg-gray-50">
                                    <input type="radio" id="ussd" name="paymentMethod" value="ussd" class="h-4 w-4">
                                    <label for="ussd" class="flex items-center cursor-pointer flex-1">
                                        <i data-lucide="phone" class="h-5 w-5 mr-3 text-[#722F37]"></i>
                                        <div>
                                            <div class="font-medium">USSD</div>
                                            <div class="text-sm text-gray-500">Pay using your mobile phone</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i data-lucide="shield" class="h-5 w-5 text-blue-500 mr-3 mt-0.5"></i>
                                <div>
                                    <h4 class="font-medium text-blue-800 mb-1">Secure Payment</h4>
                                    <p class="text-sm text-blue-700">
                                        Your payment is secured by Paystack with 256-bit SSL encryption. Your card details are never stored on our servers.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Button -->
                        <button id="pay-button" class="w-full inline-flex items-center px-4 py-3 border border-transparent text-lg font-medium rounded-md text-white bg-[#722F37] hover:bg-[#5a252a]">
                            <i data-lucide="lock" class="h-5 w-5 mr-2"></i>
                            Pay ₦20,000
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="space-y-6">
                <div class="bg-white shadow-lg border-0 rounded-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold">Payment Summary</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Application Fee</span>
                            <span class="font-medium">₦20,000</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Processing Fee</span>
                            <span class="font-medium">₦0.00</span>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold">Total</span>
                                <span class="text-lg font-bold text-[#722F37]">₦20,000</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-lg border-0 rounded-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold">What's Included</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <div class="flex items-center">
                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mr-3"></i>
                            <span class="text-sm">Application processing</span>
                        </div>
                        <div class="flex items-center">
                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mr-3"></i>
                            <span class="text-sm">Document review</span>
                        </div>
                        <div class="flex items-center">
                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mr-3"></i>
                            <span class="text-sm">Admission consideration</span>
                        </div>
                        <div class="flex items-center">
                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mr-3"></i>
                            <span class="text-sm">Email notifications</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-lg border-0 rounded-lg">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold">Need Help?</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-gray-600 mb-3">Having trouble with your payment? Our support team is here to help.</p>
                        <button class="w-full inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-transparent hover:bg-gray-50">
                            Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <form id="payment-confirm-form" action="{% url 'app:payment_confirm' %}" method="POST" class="hidden">
        {% csrf_token %}
        <input type="hidden" name="transactionRef" id="transactionRef">
        <input type="hidden" name="paymentRef" id="paymentRef">
    </form>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="col-span-1 md:col-span-2">
                    <h3 class="text-lg font-semibold text-[#722F37] mb-4">School of Postgraduate Achievers</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        Secure payment processing powered by Paystack. Your financial information is protected with industry-standard encryption.
                    </p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 mb-4">Payment Support</h4>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li><a href="#" class="hover:text-[#722F37] transition-colors">Payment FAQ</a></li>
                        <li><a href="#" class="hover:text-[#722F37] transition-colors">Refund Policy</a></li>
                        <li><a href="#" class="hover:text-[#722F37] transition-colors">Technical Support</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 mb-4">Security</h4>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex items-center"><i data-lucide="shield" class="h-3 w-3 mr-2"></i> SSL Encrypted</li>
                        <li class="flex items-center"><i data-lucide="lock" class="h-3 w-3 mr-2"></i> PCI Compliant</li>
                        <li class="flex items-center"><i data-lucide="check-circle" class="h-3 w-3 mr-2"></i> Verified by Paystack</li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-200">
                <p class="text-center text-sm text-gray-500">
                    &copy; 2024 School of Postgraduate Achievers. All rights reserved. | Powered by Paystack
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Mock user and payment data
        const mockUser = {
            firstName: "{{user.first_name}}",
            lastName: "{{user.last_name}}",
            email: "{{user.email}}",
            profileImage: "/placeholder.svg?height=40&width=40",
        };

        let paymentData = {
            email: mockUser.email,
            firstName: mockUser.firstName,
            lastName: mockUser.lastName,
            phone: "",
            paymentMethod: "card",
        };

        const PAYSTACK_PUBLIC_KEY = "pk_test_7f7cd908f629e8d13eaa25a7bc6dae862434caae"; // Replace with actual key
        const APPLICATION_FEE = 20000; // 20,000 naira

        // Payment status management
        let isLoading = false;
        let paymentStatus = "idle";

        // DOM elements
        const paymentStatusDiv = document.getElementById('payment-status');

        const payButton = document.getElementById('pay-button');
        const paymentForm = document.getElementById('payment-confirm-form');
        const transactionRefInput = document.getElementById('transactionRef');
        const paymentRefInput = document.getElementById('paymentRef');

        const inputs = {
            firstName: document.getElementById('firstName'),
            lastName: document.getElementById('lastName'),
            email: document.getElementById('email'),
            phone: document.getElementById('phone'),
        };
        const errorDisplays = {
            firstName: document.getElementById('firstName-error'),
            lastName: document.getElementById('lastName-error'),
            email: document.getElementById('email-error'),
            phone: document.getElementById('phone-error'),
        };

        // Input change handler
        function handleInputChange(field, value) {
            paymentData[field] = value;
            if (errorDisplays[field].classList.contains('hidden')) return;
            errorDisplays[field].classList.add('hidden');
            inputs[field].classList.remove('border-red-500');
            inputs[field].classList.add('border-gray-300');
        }

        // Form validation
        function validateForm() {
            const errors = {};
            if (!paymentData.email) errors.email = "Email is required";
            if (!paymentData.firstName) errors.firstName = "First name is required";
            if (!paymentData.lastName) errors.lastName = "Last name is required";
            // if (!paymentData.phone) errors.phone = "Phone number is required";

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (paymentData.email && !emailRegex.test(paymentData.email)) {
                errors.email = "Please enter a valid email address";
            }

            // const phoneRegex = /^[0-9+\-\s()]+$/;
            // if (paymentData.phone && !phoneRegex.test(paymentData.phone)) {
            //     errors.phone = "Please enter a valid phone number";
            // }

            Object.keys(errors).forEach(field => {
                errorDisplays[field].textContent = errors[field];
                errorDisplays[field].classList.remove('hidden');
                inputs[field].classList.add('border-red-500');
                inputs[field].classList.remove('border-gray-300');
            });

            return Object.keys(errors).length === 0;
        }

        // Update payment status display
        function updatePaymentStatus(status) {
            paymentStatus = status;
            paymentStatusDiv.classList.remove('hidden');
            paymentStatusDiv.innerHTML = '';
            if (status === 'success') {
                paymentStatusDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-4 flex items-center';
                paymentStatusDiv.innerHTML = `
                    <i data-lucide="check-circle" class="h-5 w-5 text-green-500 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-green-800">Payment Successful!</h4>
                        <p class="text-sm text-green-700">Your application fee has been processed successfully.</p>
                    </div>
                `;
            } else if (status === 'failed') {
                paymentStatusDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-4 flex items-center';
                paymentStatusDiv.innerHTML = `
                    <i data-lucide="alert-circle" class="h-5 w-5 text-red-500 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-red-800">Payment Failed</h4>
                        <p class="text-sm text-red-700">There was an issue processing your payment. Please try again.</p>
                    </div>
                `;
            } else if (status === 'processing') {
                paymentStatusDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center';
                paymentStatusDiv.innerHTML = `
                    <i data-lucide="clock" class="h-5 w-5 text-blue-500 mr-3 animate-spin"></i>
                    <div>
                        <h4 class="font-medium text-blue-800">Processing Payment...</h4>
                        <p class="text-sm text-blue-700">Please wait while we process your payment.</p>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat("en-NG", {
                style: "currency",
                currency: "NGN",
            }).format(amount);
        }

        // Handle payment
        async function handlePayment() {
            if (!validateForm()) return;

            isLoading = true;
            updatePaymentStatus('processing');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';

            try {
                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: paymentData.email,
                    amount: APPLICATION_FEE * 100, // Convert to kobo
                    currency: "NGN",
                    ref: `APP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    firstname: paymentData.firstName,
                    lastname: paymentData.lastName,
                    // phone: paymentData.phone,
                    metadata: {
                        custom_fields: [
                            {
                                display_name: "Application Type",
                                variable_name: "application_type",
                                value: "Postgraduate Application",
                            },
                            {
                                display_name: "User ID",
                                variable_name: "user_id",
                                value: "USER_123",
                            },
                        ],
                    },
                    callback: function (response) {
                        console.log("Payment successful:", response);
                        updatePaymentStatus('success');
                        isLoading = false;
                        payButton.disabled = true;
                        setTimeout(() => {
                            alert("Payment successful! Redirecting to dashboard click okay...");
                            transactionRefInput.value = response.reference;
                            paymentRefInput.value = response.reference; // Paystack uses 'reference' for both
                            paymentForm.submit();
                            // window.location.href = "/dashboard";
                        }, 2000);
                    },
                    onClose: function () {
                        console.log("Payment cancelled");
                        updatePaymentStatus('idle');
                        isLoading = false;
                        payButton.disabled = false;
                        payButton.innerHTML = `<i data-lucide="lock" class="h-5 w-5 mr-2"></i>Pay ${formatCurrency(APPLICATION_FEE)}`;
                        lucide.createIcons();
                    },
                });

                handler.openIframe();
            } catch (error) {
                console.error("Payment error:", error);
                updatePaymentStatus('failed');
                isLoading = false;
                payButton.disabled = false;
                payButton.innerHTML = `<i data-lucide="lock" class="h-5 w-5 mr-2"></i>Pay ${formatCurrency(APPLICATION_FEE)}`;
                lucide.createIcons();
            }
        }

        // Event listeners
        inputs.firstName.addEventListener('input', (e) => handleInputChange('firstName', e.target.value));
        inputs.lastName.addEventListener('input', (e) => handleInputChange('lastName', e.target.value));
        inputs.email.addEventListener('input', (e) => handleInputChange('email', e.target.value));
        document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
            input.addEventListener('change', (e) => handleInputChange('paymentMethod', e.target.value));
        });
        payButton.addEventListener('click', handlePayment);
    </script>
</body>
</html>